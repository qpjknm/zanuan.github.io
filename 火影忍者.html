<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«å½±å¿è€…æ ¼æ–—æ¸¸æˆ</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 3em;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ç•Œé¢åˆ‡æ¢ */
        .screen {
            display: none;
            animation: fadeIn 0.5s;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ä¸»èœå• */
        .menu {
            text-align: center;
            margin-top: 50px;
        }

        .btn {
            display: inline-block;
            padding: 15px 40px;
            margin: 15px;
            font-size: 1.2em;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* è§’è‰²é€‰æ‹© */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .character-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .character-card:hover {
            background: rgba(255,255,255,0.2);
            border-color: #ffd93d;
            transform: scale(1.05);
        }

        .character-card.selected {
            border-color: #ff6b6b;
            background: rgba(255,107,107,0.2);
        }

        .character-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .character-info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* æˆ˜æ–—ç•Œé¢ */
        .battle-arena {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 30px;
        }

        .ninja-card {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            transition: all 0.3s;
        }

        .ninja-card.defending {
            box-shadow: 0 0 20px rgba(93, 173, 226, 0.8);
        }

        .ninja-card.attacking {
            animation: attackAnim 0.5s;
        }

        .ninja-card.healing {
            animation: healAnim 0.8s;
        }

        @keyframes attackAnim {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes healAnim {
            0% { box-shadow: 0 0 0px rgba(46, 213, 115, 0.8); }
            50% { box-shadow: 0 0 30px rgba(46, 213, 115, 0.8); }
            100% { box-shadow: 0 0 0px rgba(46, 213, 115, 0); }
        }

        .ninja-name {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .health-bar, .chakra-bar {
            margin: 15px 0;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .bar-bg {
            height: 25px;
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .health-fill {
            background: linear-gradient(90deg, #ff6b6b, #c44569);
            width: 100%;
        }

        .chakra-fill {
            background: linear-gradient(90deg, #4834d4, #686de0);
            width: 100%;
        }

        /* æˆ˜æ–—æ—¥å¿— */
        .battle-log {
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 8px 0;
            padding: 5px;
            border-left: 3px solid #ffd93d;
            padding-left: 10px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* è¡ŒåŠ¨æŒ‰é’® */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .action-btn {
            padding: 12px 20px;
            font-size: 1em;
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .action-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* å¿æœ¯é€‰æ‹© */
        .jutsu-list {
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .jutsu-item {
            background: rgba(255,255,255,0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .jutsu-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .jutsu-name {
            font-weight: bold;
            color: #ffd93d;
        }

        .jutsu-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* æ¸¸æˆç»“æŸ */
        .game-over {
            text-align: center;
            padding: 50px;
        }

        .winner-text {
            font-size: 3em;
            margin: 20px 0;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .battle-arena {
                grid-template-columns: 1fr;
            }
            h1 { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»èœå• -->
        <div id="mainMenu" class="screen active">
            <h1>ğŸ”¥ ç«å½±å¿è€…æ ¼æ–—æ¸¸æˆ ğŸ”¥</h1>
            <div class="menu">
                <button class="btn" onclick="showCharacterSelect()">å¼€å§‹æ¸¸æˆ</button>
                <button class="btn" onclick="showRules()">æ¸¸æˆè§„åˆ™</button>
                <button class="btn" onclick="showCharacters()">è§’è‰²ä»‹ç»</button>
            </div>
        </div>

        <!-- è§„åˆ™è¯´æ˜ -->
        <div id="rulesScreen" class="screen">
            <h1>æ¸¸æˆè§„åˆ™</h1>
            <div style="background: rgba(0,0,0,0.4); padding: 30px; border-radius: 20px; max-width: 800px; margin: 0 auto;">
                <h2 style="margin-bottom: 20px; color: #ffd93d;">æ¸¸æˆç©æ³•ï¼š</h2>
                <ul style="list-style: none; font-size: 1.2em; line-height: 2;">
                    <li>âš”ï¸ <strong>æ™®é€šæ”»å‡»ï¼š</strong>æ¶ˆè€—0æŸ¥å…‹æ‹‰ï¼Œé€ æˆ10-25ç‚¹ä¼¤å®³</li>
                    <li>ğŸ”¥ <strong>ä½¿ç”¨å¿æœ¯ï¼š</strong>æ¶ˆè€—æŸ¥å…‹æ‹‰ï¼Œé€ æˆé«˜ä¼¤å®³æˆ–æ²»ç–—</li>
                    <li>ğŸ›¡ï¸ <strong>é˜²å¾¡ï¼š</strong>å‡å°‘ä¸‹æ¬¡å—åˆ°çš„ä¼¤å®³</li>
                    <li>ğŸ’™ <strong>æŸ¥å…‹æ‹‰ï¼š</strong>æ¯å›åˆè‡ªåŠ¨æ¢å¤15ç‚¹</li>
                    <li>â¤ï¸ <strong>ç”Ÿå‘½å€¼ï¼š</strong>é™åˆ°0å³æˆ˜è´¥</li>
                </ul>
                <button class="btn" onclick="showMainMenu()" style="margin-top: 30px;">è¿”å›ä¸»èœå•</button>
            </div>
        </div>

        <!-- è§’è‰²ä»‹ç» -->
        <div id="charactersScreen" class="screen">
            <h1>è§’è‰²ä»‹ç»</h1>
            <div id="characterList" style="max-width: 1000px; margin: 0 auto;"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="showMainMenu()">è¿”å›ä¸»èœå•</button>
            </div>
        </div>

        <!-- è§’è‰²é€‰æ‹© -->
        <div id="charSelectScreen" class="screen">
            <h1>é€‰æ‹©ä½ çš„å¿è€…</h1>
            <div id="playerSelection" class="character-grid"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" id="confirmBtn" onclick="confirmSelection()" disabled>ç¡®è®¤é€‰æ‹©</button>
                <button class="btn" onclick="showMainMenu()">è¿”å›ä¸»èœå•</button>
            </div>
        </div>

        <!-- æˆ˜æ–—ç•Œé¢ -->
        <div id="battleScreen" class="screen">
            <h1>å¿è€…å¯¹å†³</h1>
            <div class="battle-arena">
                <div id="playerCard" class="ninja-card">
                    <div class="ninja-name" id="playerName"></div>
                    <div class="health-bar">
                        <div class="bar-label">
                            <span>ç”Ÿå‘½å€¼</span>
                            <span id="playerHealthText"></span>
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill health-fill" id="playerHealthBar"></div>
                        </div>
                    </div>
                    <div class="chakra-bar">
                        <div class="bar-label">
                            <span>æŸ¥å…‹æ‹‰</span>
                            <span id="playerChakraText"></span>
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill chakra-fill" id="playerChakraBar"></div>
                        </div>
                    </div>
                </div>

                <div id="enemyCard" class="ninja-card">
                    <div class="ninja-name" id="enemyName"></div>
                    <div class="health-bar">
                        <div class="bar-label">
                            <span>ç”Ÿå‘½å€¼</span>
                            <span id="enemyHealthText"></span>
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill health-fill" id="enemyHealthBar"></div>
                        </div>
                    </div>
                    <div class="chakra-bar">
                        <div class="bar-label">
                            <span>æŸ¥å…‹æ‹‰</span>
                            <span id="enemyChakraText"></span>
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill chakra-fill" id="enemyChakraBar"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æˆ˜æ–—æ—¥å¿— -->
            <div class="battle-log" id="battleLog">
                <div class="log-entry">æˆ˜æ–—å¼€å§‹ï¼é€‰æ‹©ä½ çš„è¡ŒåŠ¨...</div>
            </div>

            <!-- è¡ŒåŠ¨æŒ‰é’® -->
            <div class="action-buttons" id="actionButtons">
                <button class="action-btn" onclick="playerAction('attack')">âš”ï¸ æ™®é€šæ”»å‡»</button>
                <button class="action-btn" onclick="showJutsuMenu()">ğŸ”¥ ä½¿ç”¨å¿æœ¯</button>
                <button class="action-btn" onclick="playerAction('defend')">ğŸ›¡ï¸ é˜²å¾¡</button>
            </div>

            <!-- å¿æœ¯é€‰æ‹©èœå• -->
            <div class="jutsu-list" id="jutsuMenu" style="display: none;"></div>
        </div>

        <!-- æ¸¸æˆç»“æŸ -->
        <div id="gameOverScreen" class="screen game-over">
            <h1>æˆ˜æ–—ç»“æŸï¼</h1>
            <div class="winner-text" id="winnerText"></div>
            <button class="btn" onclick="resetGame()">å†æ¥ä¸€å±€</button>
            <button class="btn" onclick="showMainMenu()">è¿”å›ä¸»èœå•</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            player: null,
            enemy: null,
            isPlayerTurn: true,
            selectedJutsu: null,
            turnInProgress: false
        };

        // å¿æœ¯ç±»
        class Jutsu {
            constructor(name, damage, chakraCost, description) {
                this.name = name;
                this.damage = damage;
                this.chakraCost = chakraCost;
                this.description = description;
            }
        }

        // å¿è€…ç±»
        class Ninja {
            constructor(name, clan, health, chakra) {
                this.name = name;
                this.clan = clan;
                this.maxHealth = health;
                this.health = health;
                this.maxChakra = chakra;
                this.chakra = chakra;
                this.jutsus = [];
                this.isDefending = false;
            }

            addJutsu(jutsu) {
                this.jutsus.push(jutsu);
            }

            attack(target) {
                this.isDefending = false;
                let damage = Math.floor(Math.random() * 16) + 10;
                
                if (target.isDefending) {
                    damage = Math.floor(damage / 2);
                    this.log(`ğŸ’¡ ${target.name} é˜²å¾¡äº†éƒ¨åˆ†ä¼¤å®³ï¼`);
                }
                
                target.takeDamage(damage);
                this.log(`âš”ï¸ ${this.name} çš„æ™®é€šæ”»å‡»é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`);
                
                document.getElementById('playerCard').classList.add('attacking');
                setTimeout(() => {
                    document.getElementById('playerCard').classList.remove('attacking');
                }, 500);
            }

            useJutsu(jutsuIndex, target) {
                this.isDefending = false;
                
                if (jutsuIndex < 0 || jutsuIndex >= this.jutsus.length) {
                    this.log("å¿æœ¯é€‰æ‹©é”™è¯¯ï¼");
                    return false;
                }

                const jutsu = this.jutsus[jutsuIndex];
                
                if (this.chakra < jutsu.chakraCost) {
                    this.log(`æŸ¥å…‹æ‹‰ä¸è¶³ï¼éœ€è¦ ${jutsu.chakraCost} ç‚¹ï¼Œå½“å‰åªæœ‰ ${this.chakra} ç‚¹`);
                    return false;
                }

                this.chakra -= jutsu.chakraCost;
                
                if (jutsu.damage < 0) {
                    const healAmount = Math.abs(jutsu.damage);
                    this.health = Math.min(this.maxHealth, this.health + healAmount);
                    this.log(`ğŸŒ¸ ${this.name} ä½¿ç”¨ ${jutsu.name}ï¼${jutsu.description}`);
                    this.log(`æ¢å¤äº† ${healAmount} ç‚¹ç”Ÿå‘½å€¼ï¼`);
                    
                    document.getElementById('playerCard').classList.add('healing');
                    setTimeout(() => {
                        document.getElementById('playerCard').classList.remove('healing');
                    }, 800);
                } else {
                    let damage = jutsu.damage;
                    
                    if (target.isDefending) {
                        damage = Math.floor(damage * 0.6);
                        this.log(`ğŸ’¡ ${target.name} é˜²å¾¡äº†éƒ¨åˆ†ä¼¤å®³ï¼`);
                    }
                    
                    target.takeDamage(damage);
                    this.log(`ğŸ”¥ ${this.name} ä½¿ç”¨ ${jutsu.name}ï¼${jutsu.description}`);
                    this.log(`é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼æ¶ˆè€— ${jutsu.chakraCost} ç‚¹æŸ¥å…‹æ‹‰`);
                    
                    document.getElementById('playerCard').classList.add('attacking');
                    setTimeout(() => {
                        document.getElementById('playerCard').classList.remove('attacking');
                    }, 500);
                }
                
                return true;
            }

            defend() {
                this.isDefending = true;
                this.log(`ğŸ›¡ï¸ ${this.name} è¿›å…¥é˜²å¾¡å§¿æ€ï¼`);
                document.getElementById('playerCard').classList.add('defending');
            }

            takeDamage(damage) {
                this.health -= damage;
                if (this.health < 0) this.health = 0;
            }

            restoreChakra() {
                const restore = 15;
                this.chakra = Math.min(this.maxChakra, this.chakra + restore);
                this.log(`âœ¨ ${this.name} æ¢å¤äº† ${restore} ç‚¹æŸ¥å…‹æ‹‰`);
            }

            isAlive() {
                return this.health > 0;
            }

            log(message) {
                const logDiv = document.getElementById('battleLog');
                if (!logDiv) return; // å¥å£®æ€§æ£€æŸ¥
                
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = message;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        // è§’è‰²åˆ›å»ºå‡½æ•°
        function createNaruto() {
            const naruto = new Ninja("æ¼©æ¶¡é¸£äºº", "æœ¨å¶æ‘", 120, 100);
            naruto.addJutsu(new Jutsu("å½±åˆ†èº«æœ¯", 25, 20, "åˆ¶é€ åˆ†èº«å›´æ”»æ•Œäºº"));
            naruto.addJutsu(new Jutsu("èºæ—‹ä¸¸", 45, 35, "æŸ¥å…‹æ‹‰æ—‹è½¬çš„å†²å‡»æ³¢"));
            naruto.addJutsu(new Jutsu("ä»™äººæ¨¡å¼Â·èºæ—‹ä¸¸", 65, 50, "ä»™æœ¯æŸ¥å…‹æ‹‰çš„ç»ˆæä¸€å‡»"));
            return naruto;
        }

        function createSasuke() {
            const sasuke = new Ninja("å®‡æ™ºæ³¢ä½åŠ©", "å®‡æ™ºæ³¢ä¸€æ—", 110, 110);
            sasuke.addJutsu(new Jutsu("ç«éÂ·è±ªç«çƒ", 30, 25, "å·¨å¤§çš„ç«ç„°åå™¬æ•Œäºº"));
            sasuke.addJutsu(new Jutsu("åƒé¸Ÿ", 50, 40, "é›·å±æ€§çªåˆºæ”»å‡»"));
            sasuke.addJutsu(new Jutsu("é¡»ä½èƒ½ä¹", 70, 60, "å†™è½®çœ¼çš„ç©¶æé˜²å¾¡ä¸æ”»å‡»"));
            return sasuke;
        }

        function createKakashi() {
            const kakashi = new Ninja("æ——æœ¨å¡å¡è¥¿", "æœ¨å¶æ‘", 100, 120);
            kakashi.addJutsu(new Jutsu("é›·åˆ‡", 45, 35, "é›·å±æ€§æŸ¥å…‹æ‹‰åˆ€"));
            kakashi.addJutsu(new Jutsu("åœŸéÂ·åœŸæµå£", 20, 20, "åœŸå¢™é˜²å¾¡å¹¶åå‡»"));
            kakashi.addJutsu(new Jutsu("ç¥å¨", 75, 65, "ä¸‡èŠ±ç­’å†™è½®çœ¼çš„ç©ºé—´æ‰­æ›²"));
            return kakashi;
        }

        function createSakura() {
            const sakura = new Ninja("æ˜¥é‡æ¨±", "æœ¨å¶æ‘", 90, 80);
            sakura.addJutsu(new Jutsu("æ€ªåŠ›", 40, 25, "ç²¾ç¡®æŸ¥å…‹æ‹‰æ§åˆ¶çš„æ€ªåŠ›æ‰“å‡»"));
            sakura.addJutsu(new Jutsu("åŒ»ç–—å¿æœ¯", -35, 20, "æ¢å¤è‡ªå·±35ç‚¹ç”Ÿå‘½å€¼"));
            sakura.addJutsu(new Jutsu("æ¨±èŠ±å†²", 35, 30, "å¼ºåŠ›çš„ä½“æœ¯è¿ç»­æ”»å‡»"));
            return sakura;
        }

        function createItachi() {
            const itachi = new Ninja("å®‡æ™ºæ³¢é¼¬", "å®‡æ™ºæ³¢ä¸€æ—", 105, 115);
            itachi.addJutsu(new Jutsu("å¹»æœ¯Â·æœˆè¯»", 40, 30, "å†™è½®çœ¼åˆ¶é€ çš„å¹»æœ¯ç©ºé—´"));
            itachi.addJutsu(new Jutsu("å¤©ç…§", 55, 45, "æ— æ³•ç†„ç­çš„é»‘è‰²ç«ç„°"));
            itachi.addJutsu(new Jutsu("é¡»ä½èƒ½ä¹Â·åæ‹³å‰‘", 80, 70, "å°å°ä¸€åˆ‡çš„ç©¶æç¥å™¨"));
            return itachi;
        }

        const characters = {
            "1": createNaruto,
            "2": createSasuke,
            "3": createKakashi,
            "4": createSakura,
            "5": createItachi
        };

        const characterNames = {
            "1": "æ¼©æ¶¡é¸£äºº (é«˜è¡€é‡)",
            "2": "å®‡æ™ºæ³¢ä½åŠ© (é«˜æŸ¥å…‹æ‹‰)",
            "3": "æ——æœ¨å¡å¡è¥¿ (å‡è¡¡)",
            "4": "æ˜¥é‡æ¨± (æ²»ç–—èƒ½åŠ›)",
            "5": "å®‡æ™ºæ³¢é¼¬ (å¹»æœ¯å¤§å¸ˆ)"
        };

        // ç•Œé¢æ§åˆ¶å‡½æ•°
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showMainMenu() {
            showScreen('mainMenu');
        }

        function showRules() {
            showScreen('rulesScreen');
        }

        function showCharacters() {
            showScreen('charactersScreen');
            const listDiv = document.getElementById('characterList');
            listDiv.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const char = characters[i.toString()]();
                const charDiv = document.createElement('div');
                charDiv.innerHTML = `
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin: 15px 0;">
                        <h3 style="color: #ffd93d; margin-bottom: 15px;">${char.name}</h3>
                        <p style="margin-bottom: 10px;"><strong>ç”Ÿå‘½å€¼:</strong> ${char.maxHealth} | <strong>æŸ¥å…‹æ‹‰:</strong> ${char.maxChakra}</p>
                        <p style="margin-bottom: 15px;"><strong>å¿æœ¯:</strong></p>
                        <ul style="list-style: none; padding-left: 20px;">
                            ${char.jutsus.map(j => `<li style="margin: 5px 0;">ğŸ”¥ ${j.name} (ä¼¤å®³:${j.damage} æŸ¥å…‹æ‹‰:${j.chakraCost})</li>`).join('')}
                        </ul>
                    </div>
                `;
                listDiv.appendChild(charDiv);
            }
        }

        function showCharacterSelect() {
            showScreen('charSelectScreen');
            const selectionDiv = document.getElementById('playerSelection');
            selectionDiv.innerHTML = '';
            
            for (let key in characterNames) {
                const card = document.createElement('div');
                card.className = 'character-card';
                card.dataset.character = key;
                card.innerHTML = `
                    <div class="character-name">${characters[key]().name}</div>
                    <div class="character-info">${characterNames[key]}</div>
                `;
                card.onclick = () => selectCharacter(key, card);
                selectionDiv.appendChild(card);
            }
        }

        let selectedCharacter = null;

        function selectCharacter(charKey, cardElement) {
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');
            selectedCharacter = charKey;
            document.getElementById('confirmBtn').disabled = false;
        }

        function confirmSelection() {
            if (!selectedCharacter) return;
            
            gameState.player = characters[selectedCharacter]();
            
            // éšæœºé€‰æ‹©æ•Œäºº
            const enemyKeys = Object.keys(characters).filter(k => k !== selectedCharacter);
            const enemyKey = enemyKeys[Math.floor(Math.random() * enemyKeys.length)];
            gameState.enemy = characters[enemyKey]();
            
            startBattle();
        }

        function startBattle() {
            showScreen('battleScreen');
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            document.getElementById('playerName').textContent = gameState.player.name;
            document.getElementById('enemyName').textContent = gameState.enemy.name;
            
            updateUI();
            
            // æ¸…ç©ºæˆ˜æ–—æ—¥å¿—
            document.getElementById('battleLog').innerHTML = '<div class="log-entry">æˆ˜æ–—å¼€å§‹ï¼é€‰æ‹©ä½ çš„è¡ŒåŠ¨...</div>';
            
            // ç»‘å®šæ—¥å¿—æ–¹æ³•
            gameState.player.log = function(message) {
                const logDiv = document.getElementById('battleLog');
                if (!logDiv) return;
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = message;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            };
            
            gameState.enemy.log = function(message) {
                const logDiv = document.getElementById('battleLog');
                if (!logDiv) return;
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.style.color = '#ff9999';
                entry.textContent = message;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            };
        }

        function updateUI() {
            // å¥å£®æ€§æ£€æŸ¥
            if (!gameState.player || !gameState.enemy) return;
            
            const player = gameState.player;
            const enemy = gameState.enemy;
            
            // æ›´æ–°ç©å®¶çŠ¶æ€
            document.getElementById('playerHealthText').textContent = `${player.health}/${player.maxHealth}`;
            document.getElementById('playerHealthBar').style.width = `${(player.health / player.maxHealth) * 100}%`;
            document.getElementById('playerChakraText').textContent = `${player.chakra}/${player.maxChakra}`;
            document.getElementById('playerChakraBar').style.width = `${(player.chakra / player.maxChakra) * 100}%`;
            
            // æ›´æ–°æ•ŒäººçŠ¶æ€
            document.getElementById('enemyHealthText').textContent = `${enemy.health}/${enemy.maxHealth}`;
            document.getElementById('enemyHealthBar').style.width = `${(enemy.health / enemy.maxHealth) * 100}%`;
            document.getElementById('enemyChakraText').textContent = `${enemy.chakra}/${enemy.maxChakra}`;
            document.getElementById('enemyChakraBar').style.width = `${(enemy.chakra / enemy.maxChakra) * 100}%`;
            
            // é˜²å¾¡çŠ¶æ€
            const playerCard = document.getElementById('playerCard');
            const enemyCard = document.getElementById('enemyCard');
            
            if (playerCard) {
                if (player.isDefending) {
                    playerCard.classList.add('defending');
                } else {
                    playerCard.classList.remove('defending');
                }
            }
            
            if (enemyCard) {
                if (enemy.isDefending) {
                    enemyCard.classList.add('defending');
                } else {
                    enemyCard.classList.remove('defending');
                }
            }
            
            // æŒ‰é’®çŠ¶æ€ - ä¿®å¤ç‚¹ï¼šç¡®ä¿çŠ¶æ€æ­£ç¡®åæ˜ 
            const buttons = document.querySelectorAll('.action-btn');
            buttons.forEach(btn => {
                btn.disabled = !gameState.isPlayerTurn || gameState.turnInProgress;
            });
        }

        function playerAction(action) {
            if (!gameState.isPlayerTurn || gameState.turnInProgress) return;
            
            gameState.turnInProgress = true;
            
            const player = gameState.player;
            const enemy = gameState.enemy;
            
            // é‡ç½®é˜²å¾¡çŠ¶æ€
            player.isDefending = false;
            
            switch(action) {
                case 'attack':
                    player.attack(enemy);
                    break;
                case 'defend':
                    player.defend();
                    break;
            }
            
            updateUI();
            
            if (!enemy.isAlive()) {
                endBattle(true);
                return;
            }
            
            // åˆ‡æ¢åˆ°æ•Œäººå›åˆ
            gameState.isPlayerTurn = false;
            
            setTimeout(() => {
                enemyTurn();
            }, 1500);
        }

        function showJutsuMenu() {
            if (!gameState.isPlayerTurn || gameState.turnInProgress) return;
            
            const player = gameState.player;
            const jutsuMenu = document.getElementById('jutsuMenu');
            
            jutsuMenu.innerHTML = '<h3 style="margin-bottom: 15px;">é€‰æ‹©å¿æœ¯ï¼š</h3>';
            
            player.jutsus.forEach((jutsu, index) => {
                const jutsuDiv = document.createElement('div');
                jutsuDiv.className = 'jutsu-item';
                jutsuDiv.innerHTML = `
                    <div class="jutsu-name">${jutsu.name}</div>
                    <div class="jutsu-info">
                        ${jutsu.damage < 0 ? 'æ¢å¤' : 'ä¼¤å®³'}: ${Math.abs(jutsu.damage)} | 
                        æŸ¥å…‹æ‹‰: ${jutsu.chakraCost} | 
                        ${jutsu.description}
                    </div>
                `;
                jutsuDiv.onclick = () => {
                    document.getElementById('jutsuMenu').style.display = 'none';
                    
                    if (player.useJutsu(index, gameState.enemy)) {
                        updateUI();
                        
                        if (!gameState.enemy.isAlive()) {
                            endBattle(true);
                            return;
                        }
                        
                        gameState.isPlayerTurn = false;
                        gameState.turnInProgress = false;
                        
                        setTimeout(() => {
                            enemyTurn();
                        }, 1500);
                    } else {
                        gameState.turnInProgress = false;
                    }
                };
                jutsuMenu.appendChild(jutsuDiv);
            });
            
            jutsuMenu.style.display = 'block';
        }

        function enemyTurn() {
            // ä¿®å¤ç‚¹ï¼šç¡®ä¿turnInProgressæ­£ç¡®è®¾ç½®
            gameState.turnInProgress = true;
            
            const player = gameState.player;
            const enemy = gameState.enemy;
            
            // é‡ç½®æ•Œæ–¹é˜²å¾¡çŠ¶æ€
            enemy.isDefending = false;
            
            // AIç­–ç•¥
            if (enemy.name === "æ˜¥é‡æ¨±" && enemy.health < 30 && enemy.chakra >= 20) {
                enemy.useJutsu(1, enemy);
            } else {
                const choice = Math.random();
                if (choice < 0.5 && enemy.jutsus.length > 0) {
                    const jutsuIdx = Math.floor(Math.random() * enemy.jutsus.length);
                    enemy.useJutsu(jutsuIdx, player);
                } else if (choice < 0.8) {
                    enemy.attack(player);
                } else {
                    enemy.defend();
                }
            }
            
            updateUI();
            
            if (!player.isAlive()) {
                endBattle(false);
                return;
            }
            
            // ä¿®å¤ç‚¹ï¼šç¡®ä¿æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œå›åˆç»“æŸé€»è¾‘
            setTimeout(() => {
                try {
                    // æ¢å¤æŸ¥å…‹æ‹‰
                    if (player && typeof player.restoreChakra === 'function') {
                        player.restoreChakra();
                    }
                    if (enemy && typeof enemy.restoreChakra === 'function') {
                        enemy.restoreChakra();
                    }
                    
                    // åˆ‡æ¢åˆ°ç©å®¶å›åˆ
                    gameState.isPlayerTurn = true;
                    gameState.turnInProgress = false;
                    
                    // æœ€åæ›´æ–°UI
                    updateUI();
                } catch (error) {
                    console.error("å›åˆåˆ‡æ¢é”™è¯¯:", error);
                    // å³ä½¿å‡ºé”™ä¹Ÿè¦é‡ç½®çŠ¶æ€
                    gameState.isPlayerTurn = true;
                    gameState.turnInProgress = false;
                    updateUI();
                }
            }, 1500);
        }

        function endBattle(playerWon) {
            showScreen('gameOverScreen');
            const winnerText = document.getElementById('winnerText');
            
            if (playerWon) {
                winnerText.innerHTML = `ğŸ‰ èƒœåˆ©ï¼<br>${gameState.player.name} è·èƒœï¼`;
                winnerText.style.color = '#4CAF50';
            } else {
                winnerText.innerHTML = `ğŸ’€ æˆ˜è´¥ï¼<br>${gameState.enemy.name} å¤ªå¼ºäº†...`;
                winnerText.style.color = '#f44336';
            }
        }

        function resetGame() {
            gameState = {
                player: null,
                enemy: null,
                isPlayerTurn: true,
                selectedJutsu: null,
                turnInProgress: false
            };
            selectedCharacter = null;
            showCharacterSelect();
        }
    </script>
</body>
</html>
